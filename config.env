# Cloud Run NAT Testing Configuration
# Source this file: source config.env

#==============================================================================
# PROJECT SETTINGS
#==============================================================================
# Set these before running any scripts
export PROJECT_ID="${PROJECT_ID:-your-project-id}"
export REGION="${REGION:-us-central1}"
export ZONE="${REGION}-a"

#==============================================================================
# SCALE SETTINGS
#==============================================================================
# Number of Cloud Run services to deploy (start small, scale up to 2000)
export NUM_SERVICES="${NUM_SERVICES:-10}"

# Max instances per Cloud Run service
export MAX_INSTANCES_PER_SERVICE="${MAX_INSTANCES_PER_SERVICE:-10}"

# Concurrency per instance
export CONCURRENCY="${CONCURRENCY:-80}"

#==============================================================================
# NETWORK CONFIGURATION
#==============================================================================
# VPC Names
export SERVERLESS_VPC="serverless-vpc"
export WORKLOAD_VPC_A="workload-vpc-a"
export WORKLOAD_VPC_B="workload-vpc-b"

# CIDR Ranges
export SERVERLESS_CIDR="240.0.0.0/12"      # Class E for Cloud Run subnets
export NAT_POOL_CIDR="10.255.0.0/16"        # Private NAT pool (routable)
export WORKLOAD_A_CIDR="10.1.0.0/16"        # Workload VPC A
export WORKLOAD_B_CIDR="10.2.0.0/16"        # Workload VPC B

# Subnet for workload VMs
export WORKLOAD_A_SUBNET_CIDR="10.1.0.0/24"
export WORKLOAD_B_SUBNET_CIDR="10.2.0.0/24"

# VM IPs
export VM_A_IP="10.1.0.10"
export VM_B_IP="10.2.0.10"

#==============================================================================
# NAT CONFIGURATION
#==============================================================================
# NAT Mode: shared | per-destination | per-service
#   shared:          All services share NAT IP pool
#   per-destination: Different NAT IPs for VPC A vs VPC B traffic
#   per-service:     Each service subnet gets dedicated NAT IP(s)
export NAT_MODE="${NAT_MODE:-shared}"

# Number of NAT IPs to allocate (for shared/per-destination modes)
export NAT_IP_COUNT="${NAT_IP_COUNT:-2}"

# NAT port allocation per VM (default 64, max 65536)
export NAT_MIN_PORTS_PER_VM="${NAT_MIN_PORTS_PER_VM:-1024}"

# Enable endpoint-independent mapping (better for connection reuse)
export NAT_ENDPOINT_INDEPENDENT="${NAT_ENDPOINT_INDEPENDENT:-true}"

#==============================================================================
# CLOUD RUN SETTINGS
#==============================================================================
# Container image (built and pushed by deploy script)
export SERVICE_IMAGE="gcr.io/${PROJECT_ID}/nat-test-service:latest"

# Ingress setting: internal-and-cloud-load-balancing | all
export INGRESS_SETTING="internal-and-cloud-load-balancing"

# CPU and memory
export SERVICE_CPU="1"
export SERVICE_MEMORY="512Mi"

# Timeout for requests (seconds)
export REQUEST_TIMEOUT="60"

#==============================================================================
# VM SETTINGS
#==============================================================================
export VM_MACHINE_TYPE="e2-medium"
export VM_IMAGE_FAMILY="debian-12"
export VM_IMAGE_PROJECT="debian-cloud"

#==============================================================================
# TESTING SETTINGS
#==============================================================================
# Number of requests per service in test
export REQUESTS_PER_SERVICE="${REQUESTS_PER_SERVICE:-10}"

# Delay between requests (ms)
export REQUEST_DELAY_MS="${REQUEST_DELAY_MS:-100}"

# Test timeout (seconds)
export TEST_TIMEOUT="${TEST_TIMEOUT:-300}"

#==============================================================================
# HELPER FUNCTIONS
#==============================================================================

# Calculate subnet CIDR for a given service index (0-based)
# Each service gets a /24 from the 240.0.0.0/12 range
get_service_subnet_cidr() {
    local idx=$1
    local third_octet=$((idx % 256))
    local second_octet=$((idx / 256))
    echo "240.${second_octet}.${third_octet}.0/24"
}

# Get service name for index
get_service_name() {
    local idx=$1
    printf "nat-test-svc-%04d" $idx
}

# Get subnet name for service index
get_subnet_name() {
    local idx=$1
    printf "cr-subnet-%04d" $idx
}
